#!/usr/bin/env perl

=head1 NAME

ansible_hosts

=head1 DESCRIPTION

Return JSON all zabbix host for ansible dynamic inventory

=head1 Usage

ansible_hosts

add script path to hostfile param in defaults 
section in ansinle config: ansible.cfg

=cut

use strict;
use warnings;
use Data::Dumper;
use FindBin '$RealBin';
use lib "$RealBin/../lib";
use host;
use config;
use JSON;

our $config = config->new("$RealBin/../etc/config");

my $host_obj = host->new($config);

# my $group_list = $host_obj->get_groups();
# 
# my $h = {};
# 
# if ($group_list->{result}) {
#     foreach my $group (@{$group_list->{result}}) {
#         my $host_list = $host_obj->get_hosts_by_group($group->{groupid});
# 
#         print $group->{name} . "\n";
# 
#         $h->{$group->{name}} = {
#             hosts => [ map { $_ = $_->{host} } @{$host_list->{result}} ],
#             vars => {
#                 ansible_python_interpreter => "python2",
#             }
#         };
#     }
# 
#     print to_json($h, {
#         indent => 1,
#         space_after => 1,
#     });
# }

my $host_list = $host_obj->get_hosts_by_group();

if ($host_list->{result}) {
#    print Dumper($host_list->{result});exit
    print to_json({
        all => {
            hosts => [ map { $_ = $_->{host} } @{$host_list->{result}} ],
            vars => {
                ansible_python_interpreter => "python2",
                ansible_ssh_private_key_file => $config->{'ssh-key'},
                ansible_ssh_user => "root" => $config->{'ssh-user'},
            },
        }
    },{
        indent => 1,
        space_after => 1,
    });
}
